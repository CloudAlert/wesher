name: main
on: [push, pull_request]
jobs:
  build:
    strategy:
      matrix:
        go: [ '1.18.x' ]
        os: [ ubuntu-latest ]
    name: ${{ matrix.os }}/go${{ matrix.go }}
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ matrix.go }}

      - run: go test -race -v ./...

      - run: make e2e

      - run: make release GOARCHES="amd64 arm arm64 mips mipsle mips64 mips64le"

      - uses: softprops/action-gh-release@v0.1.14
        if: startsWith(github.ref, 'refs/tags/')
        with:
          fail_on_unmatched_files: true
          files: |
            wesher-*
            wesher.sha256sums

